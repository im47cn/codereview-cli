#!/bin/bash

# 获取 Git 仓库根目录
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)

# 如果不在 Git 仓库中，退出
if [ -z "$REPO_ROOT" ]; then
    echo "❌ 错误：不在 Git 仓库中"
    exit 1
fi

# 检查提示词文件是否存在
PROMPT_FILE="$REPO_ROOT/prompts/git-commit-review-prompt.md"
if [ ! -f "$PROMPT_FILE" ]; then
    echo "❌ 错误：提示词文件不存在: $PROMPT_FILE"
    exit 1
fi

# 检查 Gemini CLI 是否可用
if ! command -v gemini &> /dev/null; then
    echo "❌ 错误：Gemini CLI 未安装"
    echo "安装命令: npm install -g @google/generative-ai-cli"
    exit 1
fi

# 创建 review_logs 目录（如果不存在）
mkdir -p "$REPO_ROOT/review_logs"

echo "🚀 正在执行 commit 后的代码审查..."

# 切换到仓库根目录执行
cd "$REPO_ROOT"

# 准备更明确的提示词
PROMPT="请执行以下任务：
1. 你是代码审查专家，需要对最新的 git commit 进行审查
2. 使用 git --no-pager show 命令获取最新提交的详细信息
3. 根据提示词文件中的指导进行全面代码审查
4. 生成审查报告并保存到 review_logs 目录
5. 不要询问用户，直接自主执行所有步骤
6. 这是一个自动化流程，请直接开始执行"

if cat "$PROMPT_FILE" | gemini -p "$PROMPT" -y; then
    echo "👌 代码审查完成"
    echo "📝 审查报告已保存到 $REPO_ROOT/review_logs 目录"
else
    echo "❌ 代码审查失败，但不影响提交"
fi